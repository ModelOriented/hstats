<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Interaction Statistics • hstats</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="bootstrap-toc.css">
<script src="bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="pkgdown.css" rel="stylesheet">
<script src="pkgdown.js"></script><meta property="og:title" content="Interaction Statistics">
<meta property="og:description" content="Fast, model-agnostic implementation of different H-statistics introduced by Jerome H. Friedman and Bogdan E. Popescu (2008) &lt;doi:10.1214/07-AOAS148&gt;. These statistics quantify interaction strength per feature, feature pair, and feature triple. The package supports multi-output predictions and can account for case weights. In addition, several variants of the original statistics are provided. The shape of the interactions can be explored through partial dependence plots or individual conditional expectation plots. DALEX explainers, meta learners (mlr3, tidymodels, caret) and most other models work out-of-the-box.">
<meta property="og:image" content="/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-home">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="index.html">hstats</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">1.2.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="reference/index.html">Reference</a>
</li>
<li>
  <a href="news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/mayer79/hstats/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="contents col-md-9">
<div class="section level1">
<div class="page-header"><h1 id="hstats-">hstats <a href="https://github.com/mayer79/hstats" class="external-link"><img src="reference/figures/logo.png" align="right" height="139"></a>
<a class="anchor" aria-label="anchor" href="#hstats-"></a>
</h1></div>
<!-- badges: start -->


<!-- badges: end -->
<div class="section level2">
<h2 id="overview">Overview<a class="anchor" aria-label="anchor" href="#overview"></a>
</h2>
<p><strong>What makes a ML model black-box? It’s the interactions!</strong></p>
<p>The first step in understanding interactions is to measure their strength. This is exactly what Friedman and Popescu’s H-statistics [1] do:</p>
<table class="table">
<colgroup>
<col width="8%">
<col width="26%">
<col width="65%">
</colgroup>
<thead><tr class="header">
<th>Statistic</th>
<th>Short description</th>
<th>How to read its value?</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><span class="math inline"><em>H</em><sub><em>j</em></sub><sup>2</sup></span></td>
<td>Overall interaction strength per feature</td>
<td>Proportion of prediction variability explained by interactions on feature <span class="math inline"><em>j</em></span>.</td>
</tr>
<tr class="even">
<td><span class="math inline"><em>H</em><sub><em>j</em><em>k</em></sub><sup>2</sup></span></td>
<td>Pairwise interaction strength</td>
<td>Proportion of joint effect variability of features <span class="math inline"><em>j</em></span> and <span class="math inline"><em>k</em></span> coming from their pairwise interaction.</td>
</tr>
<tr class="odd">
<td><span class="math inline"><em>H</em><sub><em>j</em><em>k</em><em>l</em></sub><sup>2</sup></span></td>
<td>Three-way interaction strength</td>
<td>Proportion of joint effect variability of three features coming from their three-way interaction.</td>
</tr>
</tbody>
</table>
<p>See section <a href="#background">Background</a> for details and definitions.</p>
<p>{hstats} offers these statistics comparably <strong>fast</strong> and for <strong>any model</strong>, even for multi-output models, or models with case weights. Additionally, we provide a global statistic <span class="math inline"><em>H</em><sup>2</sup></span> measuring the proportion of prediction variability unexplained by main effects [5], and an experimental feature importance measure. After having identified strong interactions, their shape can be investigated by stratified partial dependence or ICE plots.</p>
<p>The core functions <code><a href="reference/hstats.html">hstats()</a></code>, <code><a href="reference/partial_dep.html">partial_dep()</a></code>, <code><a href="reference/ice.html">ice()</a></code>, <code><a href="reference/perm_importance.html">perm_importance()</a></code>, and <code><a href="reference/average_loss.html">average_loss()</a></code> can directly be applied to DALEX explainers, meta learners (mlr3, tidymodels, caret) and most other models. In case you need more flexibility, a tailored prediction function can be specified. Both data.frame and matrix data structures are supported.</p>
</div>
<div class="section level2">
<h2 id="limitations">Limitations<a class="anchor" aria-label="anchor" href="#limitations"></a>
</h2>
<ol style="list-style-type: decimal">
<li>H-statistics are based on partial dependence estimates and are thus as good or bad as these. One of their problems is that the model is applied to unseen/impossible feature combinations. In extreme cases, H-statistics intended to be in the range between 0 and 1 can become larger than 1. Accumulated local effects (ALE) [8] mend above problem of partial dependence estimates. They, however, depend on the notion of “closeness”, which is highly non-trivial in higher dimension and for discrete features.</li>
<li>Due to their computational complexity of <span class="math inline"><em>O</em>(<em>n</em><sup>2</sup>)</span>, where <span class="math inline"><em>n</em></span> is the number of rows considered, H-statistics are usually evaluated on relatively small subsets of the training (or validation/test) data. Consequently, the estimates are typically not very robust. To get more robust results, increase the default <code>n_max = 500</code> of <code><a href="reference/hstats.html">hstats()</a></code>.</li>
</ol>
</div>
<div class="section level2">
<h2 id="landscape">Landscape<a class="anchor" aria-label="anchor" href="#landscape"></a>
</h2>
<p>{hstats} is not the first R package to explore interactions. Here is an incomplete selection:</p>
<ul>
<li>
<a href="https://CRAN.R-project.org/package=gbm" class="external-link">{gbm}</a>: Implementation of m-wise interaction statistics of [1] for {gbm} models using the weighted tree-traversal method of [2] to estimate partial dependence functions.</li>
<li>
<a href="https://CRAN.R-project.org/package=iml" class="external-link">{iml}</a>: Implementation of overall and pairwise H-statistics.</li>
<li>
<a href="https://CRAN.R-project.org/package=EIX" class="external-link">{EIX}</a>: Interaction statistics extracted from the tree structure of XGBoost and LightGBM.</li>
<li>
<a href="https://CRAN.R-project.org/package=randomForestExplainer" class="external-link">{randomForestExplainer}</a>: Interaction statistics extracted from the tree structure of random forests.</li>
<li>
<a href="https://CRAN.R-project.org/package=vivid" class="external-link">{vivid}</a>: Cool visualization of interaction patterns. Partly based on {flashlight}.</li>
<li>
<a href="https://CRAN.R-project.org/package=flashlight" class="external-link">{flashlight}</a>: Model-agnostic implementation of some statistics of [1]. Planned to switch to the much faster {hstats}.</li>
</ul>
</div>
<div class="section level2">
<h2 id="installation">Installation<a class="anchor" aria-label="anchor" href="#installation"></a>
</h2>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># From CRAN</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"hstats"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># From Github</span></span>
<span><span class="fu">devtools</span><span class="fu">::</span><span class="fu">install_github</span><span class="op">(</span><span class="st">"mayer79/hstats"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="usage">Usage<a class="anchor" aria-label="anchor" href="#usage"></a>
</h2>
<p>To demonstrate the typical workflow, we use a beautiful house price dataset with about 14,000 transactions from Miami-Dade County available in the {shapviz} package, and analyzed in [3]. We are going to model logarithmic sales prices with XGBoost.</p>
<div class="section level3">
<h3 id="fit-model">Fit model<a class="anchor" aria-label="anchor" href="#fit-model"></a>
</h3>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/mayer79/hstats" class="external-link">hstats</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/dmlc/xgboost" class="external-link">xgboost</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/ModelOriented/shapviz" class="external-link">shapviz</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">miami</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/chartr.html" class="external-link">tolower</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">miami</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">miami</span><span class="op">$</span><span class="va">log_ocean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">miami</span><span class="op">$</span><span class="va">ocean_dist</span><span class="op">)</span></span>
<span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"log_ocean"</span>, <span class="st">"tot_lvg_area"</span>, <span class="st">"lnd_sqfoot"</span>, <span class="st">"structure_quality"</span>, <span class="st">"age"</span>, <span class="st">"month_sold"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Train/valid split</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">ix</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">miami</span><span class="op">)</span>, <span class="fl">0.8</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">miami</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">y_train</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">miami</span><span class="op">$</span><span class="va">sale_prc</span><span class="op">[</span><span class="va">ix</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">y_valid</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">miami</span><span class="op">$</span><span class="va">sale_prc</span><span class="op">[</span><span class="op">-</span><span class="va">ix</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">X_train</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.matrix.html" class="external-link">data.matrix</a></span><span class="op">(</span><span class="va">miami</span><span class="op">[</span><span class="va">ix</span>, <span class="va">x</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">X_valid</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.matrix.html" class="external-link">data.matrix</a></span><span class="op">(</span><span class="va">miami</span><span class="op">[</span><span class="op">-</span><span class="va">ix</span>, <span class="va">x</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="va">dtrain</span> <span class="op">&lt;-</span> <span class="fu">xgb.DMatrix</span><span class="op">(</span><span class="va">X_train</span>, label <span class="op">=</span> <span class="va">y_train</span><span class="op">)</span></span>
<span><span class="va">dvalid</span> <span class="op">&lt;-</span> <span class="fu">xgb.DMatrix</span><span class="op">(</span><span class="va">X_valid</span>, label <span class="op">=</span> <span class="va">y_valid</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Fit via early stopping</span></span>
<span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu">xgb.train</span><span class="op">(</span></span>
<span>  params <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>learning_rate <span class="op">=</span> <span class="fl">0.15</span>, objective <span class="op">=</span> <span class="st">"reg:squarederror"</span>, max_depth <span class="op">=</span> <span class="fl">5</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">dtrain</span>,</span>
<span>  watchlist <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>valid <span class="op">=</span> <span class="va">dvalid</span><span class="op">)</span>,</span>
<span>  early_stopping_rounds <span class="op">=</span> <span class="fl">20</span>,</span>
<span>  nrounds <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>  callbacks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu">cb.print.evaluation</span><span class="op">(</span>period <span class="op">=</span> <span class="fl">100</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Mean squared error: 0.0515</span></span>
<span><span class="fu"><a href="reference/average_loss.html">average_loss</a></span><span class="op">(</span><span class="va">fit</span>, X <span class="op">=</span> <span class="va">X_valid</span>, y <span class="op">=</span> <span class="va">y_valid</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="interaction-statistics">Interaction statistics<a class="anchor" aria-label="anchor" href="#interaction-statistics"></a>
</h3>
<p>Let’s calculate different H-statistics via <code><a href="reference/hstats.html">hstats()</a></code>:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 4 seconds on simple laptop - a random forest will take 2 minutes</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">782</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span></span>
<span>  <span class="va">s</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/hstats.html">hstats</a></span><span class="op">(</span><span class="va">fit</span>, X <span class="op">=</span> <span class="va">X_train</span><span class="op">)</span>  <span class="co">#, approx = TRUE: twice as fast</span></span>
<span><span class="op">)</span></span>
<span><span class="va">s</span></span>
<span><span class="co"># H^2 (normalized)</span></span>
<span><span class="co"># [1] 0.10</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">s</span><span class="op">)</span>  <span class="co"># Or summary(s) for numeric output</span></span>
<span></span>
<span><span class="co"># Save for later</span></span>
<span><span class="co"># saveRDS(s, file = "h_statistics.rds")</span></span></code></pre></div>
<p><img src="reference/figures/hstats.svg"></p>
<p><strong>Interpretation</strong></p>
<ul>
<li>
<span class="math inline"><em>H</em><sup>2</sup></span>: About 10% of prediction variability is unexplained by the sum of all main effects. The interaction effects seem to be important.</li>
<li>
<span class="math inline"><em>H</em><sub><em>j</em></sub><sup>2</sup></span>: The strongest overall interactions are associated with “log_ocean” (logarithmic distance to the ocean): About 6% of prediction variability can be attributed to its interactions.</li>
<li>
<span class="math inline"><em>H</em><sub><em>j</em><em>k</em></sub><sup>2</sup></span>: About 8.5% of the joint effect variability of “log_ocean” and “age” comes from their pairwise interaction.</li>
</ul>
<p><strong>Remarks</strong></p>
<ol style="list-style-type: decimal">
<li>Pairwise statistics <span class="math inline"><em>H</em><sub><em>j</em><em>k</em></sub><sup>2</sup></span> are calculated only for the features with strong overall interactions <span class="math inline"><em>H</em><sub><em>j</em></sub><sup>2</sup></span>.</li>
<li>H-statistics need to repeatedly calculate predictions on up to <span class="math inline"><em>n</em><sup>2</sup></span> rows. That is why {hstats} samples 500 rows by default. To get more robust results, increase this value at the price of slower run time.</li>
<li>Pairwise statistics <span class="math inline"><em>H</em><sub><em>j</em><em>k</em></sub><sup>2</sup></span> measures interaction strength relative to the combined effect of the two features. This does not necessarily show which interactions are strongest in absolute numbers. To do so, we can study unnormalized statistics:</li>
</ol>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="reference/h2_pairwise.html">h2_pairwise</a></span><span class="op">(</span><span class="va">s</span>, normalize <span class="op">=</span> <span class="cn">FALSE</span>, squared <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="reference/figures/hstats_pairwise.svg"></p>
<p>Since distance to the ocean and age have high values in overall interaction strength, it is not surprising that a strong relative pairwise interaction is translated into a strong absolute one.</p>
<p>Note: {hstats} can crunch <strong>three-way</strong> interaction statistics <span class="math inline"><em>H</em><sub><em>j</em><em>k</em><em>l</em></sub><sup>2</sup></span> as well. To calculate them for <span class="math inline"><em>m</em></span> features with strongest overall interactions, set <code>threeway_m = m</code>.</p>
</div>
<div class="section level3">
<h3 id="describe-interaction">Describe interaction<a class="anchor" aria-label="anchor" href="#describe-interaction"></a>
</h3>
<p>Let’s study different plots to understand <em>how</em> the strong interaction between distance to the ocean and age looks like. We will check the following three visualizations.</p>
<ol style="list-style-type: decimal">
<li>Stratified PDP</li>
<li>Two-dimensional PDP (once as heatmap, once by representing the second variable on the color scale)</li>
<li>Centered ICE plot with colors</li>
</ol>
<p>They all reveal a substantial interaction between the two variables in the sense that the age effect gets weaker the closer to the ocean. Note that numeric <code>BY</code> features are automatically binned into quartile groups.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="reference/partial_dep.html">partial_dep</a></span><span class="op">(</span><span class="va">fit</span>, v <span class="op">=</span> <span class="st">"age"</span>, X <span class="op">=</span> <span class="va">X_train</span>, BY <span class="op">=</span> <span class="st">"log_ocean"</span><span class="op">)</span>, show_points <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p><img src="reference/figures/pdp_ocean_age.svg"></p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pd</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/partial_dep.html">partial_dep</a></span><span class="op">(</span><span class="va">fit</span>, v <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"age"</span>, <span class="st">"log_ocean"</span><span class="op">)</span>, X <span class="op">=</span> <span class="va">X_train</span>, grid_size <span class="op">=</span> <span class="fl">1000</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">pd</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">pd</span>, d2_geom <span class="op">=</span> <span class="st">"line"</span>, show_points <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p><img src="reference/figures/pdp_2d.svg"><img src="reference/figures/pdp_2d_line.svg"></p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ic</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ice.html">ice</a></span><span class="op">(</span><span class="va">fit</span>, v <span class="op">=</span> <span class="st">"age"</span>, X <span class="op">=</span> <span class="va">X_train</span>, BY <span class="op">=</span> <span class="st">"log_ocean"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">ic</span>, center <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p><img src="reference/figures/ice.svg"></p>
</div>
<div class="section level3">
<h3 id="variable-importance">Variable importance<a class="anchor" aria-label="anchor" href="#variable-importance"></a>
</h3>
<p>In the spirit of [1], and related to [4], we can extract from the “hstats” objects a partial dependence based variable importance measure. It measures not only the main effect strength (see [4]), but also all its interaction effects. It is rather experimental, so use it with care (details in the section “Background”):</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="reference/pd_importance.html">pd_importance</a></span><span class="op">(</span><span class="va">s</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Compared with four times repeated permutation importance regarding MSE</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="reference/perm_importance.html">perm_importance</a></span><span class="op">(</span><span class="va">fit</span>, X <span class="op">=</span> <span class="va">X_valid</span>, y <span class="op">=</span> <span class="va">y_valid</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="reference/figures/importance.svg"></p>
<p>Permutation importance returns the same order in this case:</p>
<p><img src="reference/figures/importance_perm.svg"></p>
</div>
</div>
<div class="section level2">
<h2 id="dalex">DALEX<a class="anchor" aria-label="anchor" href="#dalex"></a>
</h2>
<p>The main functions work smoothly on DALEX explainers:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/mayer79/hstats" class="external-link">hstats</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://modeloriented.github.io/DALEX/" class="external-link">DALEX</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://imbs-hl.github.io/ranger/" class="external-link">ranger</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu">ranger</span><span class="op">(</span><span class="va">Sepal.Length</span> <span class="op">~</span> <span class="va">.</span>, data <span class="op">=</span> <span class="va">iris</span><span class="op">)</span></span>
<span><span class="va">ex</span> <span class="op">&lt;-</span> <span class="fu">DALEX</span><span class="fu">::</span><span class="fu">explain</span><span class="op">(</span><span class="va">fit</span>, data <span class="op">=</span> <span class="va">iris</span><span class="op">[</span>, <span class="op">-</span><span class="fl">1</span><span class="op">]</span>, y <span class="op">=</span> <span class="va">iris</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="va">s</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/hstats.html">hstats</a></span><span class="op">(</span><span class="va">ex</span><span class="op">)</span></span>
<span><span class="va">s</span>  <span class="co"># 0.054</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">s</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Strongest relative interaction</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="reference/ice.html">ice</a></span><span class="op">(</span><span class="va">ex</span>, v <span class="op">=</span> <span class="st">"Sepal.Width"</span>, BY <span class="op">=</span> <span class="st">"Petal.Width"</span><span class="op">)</span>, center <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="reference/partial_dep.html">partial_dep</a></span><span class="op">(</span><span class="va">ex</span>, v <span class="op">=</span> <span class="st">"Sepal.Width"</span>, BY <span class="op">=</span> <span class="st">"Petal.Width"</span><span class="op">)</span>, show_points <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="reference/partial_dep.html">partial_dep</a></span><span class="op">(</span><span class="va">ex</span>, v <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Sepal.Width"</span>, <span class="st">"Petal.Width"</span><span class="op">)</span>, grid_size <span class="op">=</span> <span class="fl">200</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="reference/perm_importance.html">perm_importance</a></span><span class="op">(</span><span class="va">ex</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Permutation importance</span></span>
<span><span class="co"># Petal.Length  Petal.Width  Sepal.Width      Species </span></span>
<span><span class="co">#   0.59836442   0.11625137   0.07966910   0.03982554 </span></span></code></pre></div>
<p><img src="reference/figures/dalex_hstats.svg"></p>
<p>Strongest relative interaction shown as ICE plot.</p>
<p><img src="reference/figures/dalex_ice.svg"></p>
</div>
<div class="section level2">
<h2 id="multivariate-responses">Multivariate responses<a class="anchor" aria-label="anchor" href="#multivariate-responses"></a>
</h2>
<p>{hstats} works also with multivariate output, see examples for probabilistic classification with</p>
<ul>
<li>ranger,</li>
<li>LightGBM, and</li>
<li>XGBoost.</li>
</ul>
<div class="section level3">
<h3 id="common-preparation">Common preparation<a class="anchor" aria-label="anchor" href="#common-preparation"></a>
</h3>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/mayer79/hstats" class="external-link">hstats</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">ix</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">40</span>, <span class="fl">51</span><span class="op">:</span><span class="fl">90</span>, <span class="fl">101</span><span class="op">:</span><span class="fl">140</span><span class="op">)</span></span>
<span><span class="va">train</span> <span class="op">&lt;-</span> <span class="va">iris</span><span class="op">[</span><span class="va">ix</span>, <span class="op">]</span></span>
<span><span class="va">valid</span> <span class="op">&lt;-</span> <span class="va">iris</span><span class="op">[</span><span class="op">-</span><span class="va">ix</span>, <span class="op">]</span></span>
<span></span>
<span><span class="va">X_train</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.matrix.html" class="external-link">data.matrix</a></span><span class="op">(</span><span class="va">train</span><span class="op">[</span>, <span class="op">-</span><span class="fl">5</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">X_valid</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.matrix.html" class="external-link">data.matrix</a></span><span class="op">(</span><span class="va">valid</span><span class="op">[</span>, <span class="op">-</span><span class="fl">5</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">y_train</span> <span class="op">&lt;-</span> <span class="va">train</span><span class="op">[[</span><span class="fl">5</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="va">y_valid</span> <span class="op">&lt;-</span> <span class="va">valid</span><span class="op">[[</span><span class="fl">5</span><span class="op">]</span><span class="op">]</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="ranger">ranger<a class="anchor" aria-label="anchor" href="#ranger"></a>
</h3>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://imbs-hl.github.io/ranger/" class="external-link">ranger</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu">ranger</span><span class="op">(</span><span class="va">Species</span> <span class="op">~</span> <span class="va">.</span>, data <span class="op">=</span> <span class="va">train</span>, probability <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="reference/average_loss.html">average_loss</a></span><span class="op">(</span><span class="va">fit</span>, X <span class="op">=</span> <span class="va">valid</span>, y <span class="op">=</span> <span class="st">"Species"</span>, loss <span class="op">=</span> <span class="st">"mlogloss"</span><span class="op">)</span>  <span class="co"># 0.02</span></span>
<span></span>
<span><span class="fu"><a href="reference/perm_importance.html">perm_importance</a></span><span class="op">(</span><span class="va">fit</span>, X <span class="op">=</span> <span class="va">iris</span>, y <span class="op">=</span> <span class="st">"Species"</span>, loss <span class="op">=</span> <span class="st">"mlogloss"</span><span class="op">)</span></span>
<span></span>
<span><span class="op">(</span><span class="va">s</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/hstats.html">hstats</a></span><span class="op">(</span><span class="va">fit</span>, X <span class="op">=</span> <span class="va">iris</span><span class="op">[</span>, <span class="op">-</span><span class="fl">5</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">s</span>, normalize <span class="op">=</span> <span class="cn">FALSE</span>, squared <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="reference/ice.html">ice</a></span><span class="op">(</span><span class="va">fit</span>, v <span class="op">=</span> <span class="st">"Petal.Length"</span>, X <span class="op">=</span> <span class="va">iris</span>, BY <span class="op">=</span> <span class="st">"Petal.Width"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span>center <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p><img src="reference/figures/multivariate.svg"></p>
<p><img src="reference/figures/multivariate_ice.svg"></p>
</div>
<div class="section level3">
<h3 id="lightgbm">LightGBM<a class="anchor" aria-label="anchor" href="#lightgbm"></a>
</h3>
<p>Note: Versions &lt; 4.0.0 require passing <code>reshape = TRUE</code> to the prediction function.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/Microsoft/LightGBM" class="external-link">lightgbm</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="va">params</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>objective <span class="op">=</span> <span class="st">"multiclass"</span>, num_class <span class="op">=</span> <span class="fl">3</span>, learning_rate <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span></span>
<span><span class="va">dtrain</span> <span class="op">&lt;-</span> <span class="fu">lgb.Dataset</span><span class="op">(</span><span class="va">X_train</span>, label <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="va">y_train</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">dvalid</span> <span class="op">&lt;-</span> <span class="fu">lgb.Dataset</span><span class="op">(</span><span class="va">X_valid</span>, label <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="va">y_valid</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu">lgb.train</span><span class="op">(</span></span>
<span>  params <span class="op">=</span> <span class="va">params</span>, </span>
<span>  data <span class="op">=</span> <span class="va">dtrain</span>,</span>
<span>  valids <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>valid <span class="op">=</span> <span class="va">dvalid</span><span class="op">)</span>,</span>
<span>  early_stopping_rounds <span class="op">=</span> <span class="fl">20</span>,</span>
<span>  nrounds <span class="op">=</span> <span class="fl">1000</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># mlogloss: 9.331699e-05</span></span>
<span><span class="fu"><a href="reference/average_loss.html">average_loss</a></span><span class="op">(</span><span class="va">fit</span>, X <span class="op">=</span> <span class="va">X_valid</span>, y <span class="op">=</span> <span class="va">y_valid</span>, loss <span class="op">=</span> <span class="st">"mlogloss"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="reference/perm_importance.html">perm_importance</a></span><span class="op">(</span><span class="va">fit</span>, X <span class="op">=</span> <span class="va">X_valid</span>, y <span class="op">=</span> <span class="va">y_valid</span>, loss <span class="op">=</span> <span class="st">"mlogloss"</span>, m_rep <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></span>
<span><span class="co"># Permutation importance regarding mlogloss</span></span>
<span><span class="co"># Petal.Length  Petal.Width  Sepal.Width Sepal.Length </span></span>
<span><span class="co">#  2.624241332  1.011168660  0.082477177  0.009757393</span></span>
<span></span>
<span><span class="fu"><a href="reference/partial_dep.html">partial_dep</a></span><span class="op">(</span><span class="va">fit</span>, v <span class="op">=</span> <span class="st">"Petal.Length"</span>, X <span class="op">=</span> <span class="va">X_train</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span>show_points <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="reference/ice.html">ice</a></span><span class="op">(</span><span class="va">fit</span>, v <span class="op">=</span> <span class="st">"Petal.Length"</span>, X <span class="op">=</span> <span class="va">X_train</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">0.05</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Interaction statistics, including three-way stats</span></span>
<span><span class="op">(</span><span class="va">H</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/hstats.html">hstats</a></span><span class="op">(</span><span class="va">fit</span>, X <span class="op">=</span> <span class="va">X_train</span>, threeway_m <span class="op">=</span> <span class="fl">4</span><span class="op">)</span><span class="op">)</span>  </span>
<span><span class="co"># 0.3010446 0.4167927 0.1623982</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">H</span>, ncol <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p><img src="reference/figures/lightgbm.svg"></p>
</div>
<div class="section level3">
<h3 id="xgboost">XGBoost<a class="anchor" aria-label="anchor" href="#xgboost"></a>
</h3>
<p>Mind the <code>reshape = TRUE</code> sent to the prediction function.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/dmlc/xgboost" class="external-link">xgboost</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="va">params</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>objective <span class="op">=</span> <span class="st">"multi:softprob"</span>, num_class <span class="op">=</span> <span class="fl">3</span>, learning_rate <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span></span>
<span><span class="va">dtrain</span> <span class="op">&lt;-</span> <span class="fu">xgb.DMatrix</span><span class="op">(</span><span class="va">X_train</span>, label <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="va">y_train</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">dvalid</span> <span class="op">&lt;-</span> <span class="fu">xgb.DMatrix</span><span class="op">(</span><span class="va">X_valid</span>, label <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="va">y_valid</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu">xgb.train</span><span class="op">(</span></span>
<span>  params <span class="op">=</span> <span class="va">params</span>, </span>
<span>  data <span class="op">=</span> <span class="va">dtrain</span>,</span>
<span>  watchlist <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>valid <span class="op">=</span> <span class="va">dvalid</span><span class="op">)</span>,</span>
<span>  early_stopping_rounds <span class="op">=</span> <span class="fl">20</span>,</span>
<span>  nrounds <span class="op">=</span> <span class="fl">1000</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># We need to pass reshape = TRUE to get a beautiful matrix</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">fit</span>, <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">X_train</span>, <span class="fl">2</span><span class="op">)</span>, reshape <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#           [,1]        [,2]         [,3]</span></span>
<span><span class="co"># [1,] 0.9974016 0.002130089 0.0004682819</span></span>
<span><span class="co"># [2,] 0.9971375 0.002129525 0.0007328897</span></span>
<span></span>
<span><span class="co"># mlogloss: 0.006689544</span></span>
<span><span class="fu"><a href="reference/average_loss.html">average_loss</a></span><span class="op">(</span><span class="va">fit</span>, X <span class="op">=</span> <span class="va">X_valid</span>, y <span class="op">=</span> <span class="va">y_valid</span>, loss <span class="op">=</span> <span class="st">"mlogloss"</span>, reshape <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="reference/partial_dep.html">partial_dep</a></span><span class="op">(</span><span class="va">fit</span>, v <span class="op">=</span> <span class="st">"Petal.Length"</span>, X <span class="op">=</span> <span class="va">X_train</span>, reshape <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span>show_points <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="reference/ice.html">ice</a></span><span class="op">(</span><span class="va">fit</span>, v <span class="op">=</span> <span class="st">"Petal.Length"</span>, X <span class="op">=</span> <span class="va">X_train</span>, reshape <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">0.05</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="reference/perm_importance.html">perm_importance</a></span><span class="op">(</span></span>
<span>  <span class="va">fit</span>, X <span class="op">=</span> <span class="va">X_valid</span>, y <span class="op">=</span> <span class="va">y_valid</span>, loss <span class="op">=</span> <span class="st">"mlogloss"</span>, reshape <span class="op">=</span> <span class="cn">TRUE</span>, m_rep <span class="op">=</span> <span class="fl">100</span></span>
<span><span class="op">)</span></span>
<span><span class="co"># Permutation importance regarding mlogloss</span></span>
<span><span class="co"># Petal.Length  Petal.Width Sepal.Length  Sepal.Width </span></span>
<span><span class="co">#  1.731532873  0.276671377  0.009158659  0.005717263 </span></span>
<span></span>
<span><span class="co"># Interaction statistics including three-way stats</span></span>
<span><span class="op">(</span><span class="va">H</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/hstats.html">hstats</a></span><span class="op">(</span><span class="va">fit</span>, X <span class="op">=</span> <span class="va">X_train</span>, reshape <span class="op">=</span> <span class="cn">TRUE</span>, threeway_m <span class="op">=</span> <span class="fl">4</span><span class="op">)</span><span class="op">)</span>  </span>
<span><span class="co"># 0.02714399 0.16067364 0.11606973</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">H</span>, normalize <span class="op">=</span> <span class="cn">FALSE</span>, squared <span class="op">=</span> <span class="cn">FALSE</span>, facet_scales <span class="op">=</span> <span class="st">"free_y"</span>, ncol <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p><img src="reference/figures/xgboost.svg"></p>
</div>
</div>
<div class="section level2">
<h2 id="meta-learning-packages">Meta-learning packages<a class="anchor" aria-label="anchor" href="#meta-learning-packages"></a>
</h2>
<p>Here, we provide examples for {tidymodels}, {caret}, and {mlr3}.</p>
<div class="section level3">
<h3 id="tidymodels">tidymodels<a class="anchor" aria-label="anchor" href="#tidymodels"></a>
</h3>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/mayer79/hstats" class="external-link">hstats</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidymodels.tidymodels.org" class="external-link">tidymodels</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="va">iris_recipe</span> <span class="op">&lt;-</span> <span class="va">iris</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">recipe</span><span class="op">(</span><span class="va">Sepal.Length</span> <span class="op">~</span> <span class="va">.</span><span class="op">)</span></span>
<span></span>
<span><span class="va">reg</span> <span class="op">&lt;-</span> <span class="fu">linear_reg</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">set_engine</span><span class="op">(</span><span class="st">"lm"</span><span class="op">)</span></span>
<span>  </span>
<span><span class="va">iris_wf</span> <span class="op">&lt;-</span> <span class="fu">workflow</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">add_recipe</span><span class="op">(</span><span class="va">iris_recipe</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">add_model</span><span class="op">(</span><span class="va">reg</span><span class="op">)</span></span>
<span></span>
<span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="va">iris_wf</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">fit</span><span class="op">(</span><span class="va">iris</span><span class="op">)</span></span>
<span>  </span>
<span><span class="va">s</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/hstats.html">hstats</a></span><span class="op">(</span><span class="va">fit</span>, X <span class="op">=</span> <span class="va">iris</span><span class="op">[</span>, <span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">s</span> <span class="co"># 0 -&gt; no interactions</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="reference/partial_dep.html">partial_dep</a></span><span class="op">(</span><span class="va">fit</span>, v <span class="op">=</span> <span class="st">"Petal.Width"</span>, X <span class="op">=</span> <span class="va">iris</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">imp</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/perm_importance.html">perm_importance</a></span><span class="op">(</span><span class="va">fit</span>, X <span class="op">=</span> <span class="va">iris</span>, y <span class="op">=</span> <span class="st">"Sepal.Length"</span><span class="op">)</span></span>
<span><span class="va">imp</span></span>
<span><span class="co"># Permutation importance</span></span>
<span><span class="co"># Petal.Length      Species  Petal.Width  Sepal.Width </span></span>
<span><span class="co">#   4.39197781   0.35038891   0.11966090   0.09604322 </span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">imp</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="caret">caret<a class="anchor" aria-label="anchor" href="#caret"></a>
</h3>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/mayer79/hstats" class="external-link">hstats</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/topepo/caret/" class="external-link">caret</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu">train</span><span class="op">(</span></span>
<span>  <span class="va">Sepal.Length</span> <span class="op">~</span> <span class="va">.</span>, </span>
<span>  data <span class="op">=</span> <span class="va">iris</span>, </span>
<span>  method <span class="op">=</span> <span class="st">"lm"</span>, </span>
<span>  tuneGrid <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>intercept <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>  trControl <span class="op">=</span> <span class="fu">trainControl</span><span class="op">(</span>method <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="reference/h2.html">h2</a></span><span class="op">(</span><span class="fu"><a href="reference/hstats.html">hstats</a></span><span class="op">(</span><span class="va">fit</span>, X <span class="op">=</span> <span class="va">iris</span><span class="op">[</span>, <span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>  <span class="co"># 0</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="reference/ice.html">ice</a></span><span class="op">(</span><span class="va">fit</span>, v <span class="op">=</span> <span class="st">"Petal.Width"</span>, X <span class="op">=</span> <span class="va">iris</span><span class="op">)</span>, center <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="reference/perm_importance.html">perm_importance</a></span><span class="op">(</span><span class="va">fit</span>, X <span class="op">=</span> <span class="va">iris</span>, y <span class="op">=</span> <span class="st">"Sepal.Length"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="mlr3">mlr3<a class="anchor" aria-label="anchor" href="#mlr3"></a>
</h3>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/mayer79/hstats" class="external-link">hstats</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://mlr3.mlr-org.com" class="external-link">mlr3</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://mlr3learners.mlr-org.com" class="external-link">mlr3learners</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Probabilistic classification</span></span>
<span><span class="va">task_iris</span> <span class="op">&lt;-</span> <span class="va">TaskClassif</span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>id <span class="op">=</span> <span class="st">"class"</span>, backend <span class="op">=</span> <span class="va">iris</span>, target <span class="op">=</span> <span class="st">"Species"</span><span class="op">)</span></span>
<span><span class="va">fit_rf</span> <span class="op">&lt;-</span> <span class="fu">lrn</span><span class="op">(</span><span class="st">"classif.ranger"</span>, predict_type <span class="op">=</span> <span class="st">"prob"</span><span class="op">)</span></span>
<span><span class="va">fit_rf</span><span class="op">$</span><span class="fu">train</span><span class="op">(</span><span class="va">task_iris</span><span class="op">)</span></span>
<span><span class="va">s</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/hstats.html">hstats</a></span><span class="op">(</span><span class="va">fit_rf</span>, X <span class="op">=</span> <span class="va">iris</span><span class="op">[</span>, <span class="op">-</span><span class="fl">5</span><span class="op">]</span>, predict_type <span class="op">=</span> <span class="st">"prob"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">s</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Permutation importance (wrt multi-logloss)</span></span>
<span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/perm_importance.html">perm_importance</a></span><span class="op">(</span></span>
<span>  <span class="va">fit_rf</span>, X <span class="op">=</span> <span class="va">iris</span>, y <span class="op">=</span> <span class="st">"Species"</span>, loss <span class="op">=</span> <span class="st">"mlogloss"</span>, predict_type <span class="op">=</span> <span class="st">"prob"</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">p</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="background">Background<a class="anchor" aria-label="anchor" href="#background"></a>
</h2>
<p>In [1], Friedman and Popescu introduced different statistics to measure interaction strength based on partial dependence functions. Closely following their notation, we will summarize the main ideas.</p>
<div class="section level3">
<h3 id="partial-dependence">Partial dependence<a class="anchor" aria-label="anchor" href="#partial-dependence"></a>
</h3>
<p>Let <span class="math inline"><em>F</em> : <em>R</em><sup><em>p</em></sup> → <em>R</em></span> denote the prediction function that maps the <span class="math inline"><em>p</em></span>-dimensional feature vector <span class="math inline"><strong>x</strong> = (<em>x</em><sub>1</sub>,…,<em>x</em><sub><em>p</em></sub>)</span> to its prediction. Furthermore, let <span class="math inline"><em>F</em><sub><em>s</em></sub>(<strong>x</strong><sub><em>s</em></sub>) = <em>E</em><sub><strong>x</strong><sub>\<em>s</em></sub></sub>(<em>F</em>(<strong>x</strong><sub><em>s</em></sub>,<strong>x</strong><sub>\<em>s</em></sub>))</span> be the partial dependence function of <span class="math inline"><em>F</em></span> on the feature subset <span class="math inline"><strong>x</strong><sub><em>s</em></sub></span>, where <span class="math inline"><em>s</em> ⊆ {1, …, <em>p</em>}</span>, as introduced in [2]. Here, the expectation runs over the joint marginal distribution of features <span class="math inline"><strong>x</strong><sub>\<em>s</em></sub></span> not in <span class="math inline"><strong>x</strong><sub><em>s</em></sub></span>.</p>
<p>Given data, <span class="math inline"><em>F</em><sub><em>s</em></sub>(<strong>x</strong><sub><em>s</em></sub>)</span> can be estimated by the empirical partial dependence function</p>
<p><span class="math display">$$
  \hat F_s(\boldsymbol x_s) = \frac{1}{n} \sum_{i = 1}^n F(\boldsymbol x_s, \boldsymbol x_{i \setminus s}),
$$</span></p>
<p>where <span class="math inline"><strong>x</strong><sub><em>i</em> \ <em>s</em></sub></span>, <span class="math inline"><em>i</em> = 1, …, <em>n</em></span>, are the observed values of <span class="math inline"><strong>x</strong><sub>\<em>s</em></sub></span>.</p>
<p>A partial dependence plot (PDP) plots the values of <span class="math inline"><em>F̂</em><sub><em>s</em></sub>(<strong>x</strong><sub><em>s</em></sub>)</span> over a grid of evaluation points <span class="math inline"><strong>x</strong><sub><em>s</em></sub></span>. Its disaggregated version is called <em>individual conditional expectation</em> (ICE), see [7].</p>
</div>
<div class="section level3">
<h3 id="overall-interaction-strength">Overall interaction strength<a class="anchor" aria-label="anchor" href="#overall-interaction-strength"></a>
</h3>
<p>If there are no interactions involving <span class="math inline"><em>x</em><sub><em>j</em></sub></span>, we can decompose the prediction function <span class="math inline"><em>F</em></span> into the sum of the partial dependence <span class="math inline"><em>F</em><sub><em>j</em></sub></span> on <span class="math inline"><em>x</em><sub><em>j</em></sub></span> and the partial dependence <span class="math inline"><em>F</em><sub>\<em>j</em></sub></span> on all other features <span class="math inline"><strong>x</strong><sub>\<em>j</em></sub></span>, i.e.,</p>
<p><span class="math display"><em>F</em>(<strong>x</strong>) = <em>F</em><sub><em>j</em></sub>(<em>x</em><sub><em>j</em></sub>) + <em>F</em><sub>\<em>j</em></sub>(<strong>x</strong><sub>\<em>j</em></sub>).</span></p>
<p>Correspondingly, Friedman and Popescu’s statistic of overall interaction strength of <span class="math inline"><em>x</em><sub><em>j</em></sub></span> is given by</p>
<p><span class="math display">$$
    H_{j}^2 = \frac{\frac{1}{n} \sum_{i = 1}^n\big[F(\boldsymbol x_i) - \hat F_j(x_{ij}) - \hat F_{\setminus j}(\boldsymbol x_{i\setminus j})\big]^2}{\frac{1}{n} \sum_{i = 1}^n\big[F(\boldsymbol x_i)\big]^2}.
$$</span></p>
<p><strong>Remarks</strong></p>
<ol style="list-style-type: decimal">
<li>Partial dependence functions (and <span class="math inline"><em>F</em></span>) are all centered to mean 0.</li>
<li>Partial dependence functions (and <span class="math inline"><em>F</em></span>) are evaluated over the data distribution. This is different to partial dependence plots, where one uses a fixed grid.</li>
<li>Weighted versions follow by replacing all arithmetic means by corresponding weighted means.</li>
<li>Multivariate predictions can be treated in a component-wise manner.</li>
<li>Due to (typically undesired) extrapolation effects of partial dependence functions, depending on the model, values above 1 may occur.</li>
<li>
<span class="math inline"><em>H</em><sub><em>j</em></sub><sup>2</sup> = 0</span> means there are no interactions associated with <span class="math inline"><em>x</em><sub><em>j</em></sub></span>. The higher the value, the more prediction variability comes from interactions with <span class="math inline"><em>x</em><sub><em>j</em></sub></span>.</li>
<li>Since the denominator is the same for all features, the values of the test statistics can be compared across features.</li>
</ol>
</div>
<div class="section level3">
<h3 id="pairwise-interaction-strength">Pairwise interaction strength<a class="anchor" aria-label="anchor" href="#pairwise-interaction-strength"></a>
</h3>
<p>Again following [1], if there are no interaction effects between features <span class="math inline"><em>x</em><sub><em>j</em></sub></span> and <span class="math inline"><em>x</em><sub><em>k</em></sub></span>, their two-dimensional partial dependence function <span class="math inline"><em>F</em><sub><em>j</em><em>k</em></sub></span> can be written as the sum of the univariate partial dependencies, i.e.,</p>
<p><span class="math display"><em>F</em><sub><em>j</em><em>k</em></sub>(<em>x</em><sub><em>j</em></sub>,<em>x</em><sub><em>k</em></sub>) = <em>F</em><sub><em>j</em></sub>(<em>x</em><sub><em>j</em></sub>) + <em>F</em><sub><em>k</em></sub>(<em>x</em><sub><em>k</em></sub>).</span></p>
<p>Correspondingly, Friedman and Popescu’s statistic of pairwise interaction strength between <span class="math inline"><em>x</em><sub><em>j</em></sub></span> and <span class="math inline"><em>x</em><sub><em>k</em></sub></span> is defined as</p>
<p><span class="math display">$$
  H_{jk}^2 = \frac{A_{jk}}{\frac{1}{n} \sum_{i = 1}^n\big[\hat F_{jk}(x_{ij}, x_{ik})\big]^2}
$$</span></p>
<p>where</p>
<p><span class="math display">$$
  A_{jk} = \frac{1}{n} \sum_{i = 1}^n\big[\hat F_{jk}(x_{ij}, x_{ik}) - \hat F_j(x_{ij}) - \hat F_k(x_{ik})\big]^2.
$$</span></p>
<p><strong>Remarks</strong></p>
<ol style="list-style-type: decimal">
<li>Remarks 1 to 4 of <span class="math inline"><em>H</em><sub><em>j</em></sub><sup>2</sup></span> also apply here.</li>
<li>
<span class="math inline"><em>H</em><sub><em>j</em><em>k</em></sub><sup>2</sup> = 0</span> means there are no interaction effects between <span class="math inline"><em>x</em><sub><em>j</em></sub></span> and <span class="math inline"><em>x</em><sub><em>k</em></sub></span>. The larger the value, the more of the joint effect of the two features comes from the interaction.</li>
<li>Since the denominator differs between variable pairs, unlike <span class="math inline"><em>H</em><sub><em>j</em></sub></span>, this test statistic is difficult to compare between variable pairs. If both main effects are very weak, a negligible interaction can get a high <span class="math inline"><em>H</em><sub><em>j</em><em>k</em></sub><sup>2</sup></span>.</li>
</ol>
<p><strong>Modification</strong></p>
<p>To be better able to compare pairwise interaction strength across variable pairs, and to overcome the problem mentioned in the last remark, we suggest as alternative the unnormalized test statistic on the scale of the predictions, i.e., <span class="math inline">$\sqrt{A_{jk}}$</span>.</p>
<p>Furthermore, instead of focusing on pairwise calculations for the most <em>important</em> features, we can select features with <em>strongest overall interactions</em>.</p>
</div>
<div class="section level3">
<h3 id="three-way-interactions">Three-way interactions<a class="anchor" aria-label="anchor" href="#three-way-interactions"></a>
</h3>
<p>[1] also describes a test statistic to measure three-way interactions: in case there are no three-way interactions between features <span class="math inline"><em>x</em><sub><em>j</em></sub></span>, <span class="math inline"><em>x</em><sub><em>k</em></sub></span> and <span class="math inline"><em>x</em><sub><em>l</em></sub></span>, their three-dimensional partial dependence function <span class="math inline"><em>F</em><sub><em>j</em><em>k</em><em>l</em></sub></span> can be decomposed into lower order terms:</p>
<p><span class="math display"><em>F</em><sub><em>j</em><em>k</em><em>l</em></sub>(<em>x</em><sub><em>j</em></sub>,<em>x</em><sub><em>k</em></sub>,<em>x</em><sub><em>l</em></sub>) = <em>B</em><sub><em>j</em><em>k</em><em>l</em></sub> − <em>C</em><sub><em>j</em><em>k</em><em>l</em></sub></span></p>
<p>with</p>
<p><span class="math display"><em>B</em><sub><em>j</em><em>k</em><em>l</em></sub> = <em>F</em><sub><em>j</em><em>k</em></sub>(<em>x</em><sub><em>j</em></sub>,<em>x</em><sub><em>k</em></sub>) + <em>F</em><sub><em>j</em><em>l</em></sub>(<em>x</em><sub><em>j</em></sub>,<em>x</em><sub><em>l</em></sub>) + <em>F</em><sub><em>k</em><em>l</em></sub>(<em>x</em><sub><em>k</em></sub>,<em>x</em><sub><em>l</em></sub>)</span></p>
<p>and</p>
<p><span class="math display"><em>C</em><sub><em>j</em><em>k</em><em>l</em></sub> = <em>F</em><sub><em>j</em></sub>(<em>x</em><sub><em>j</em></sub>) + <em>F</em><sub><em>k</em></sub>(<em>x</em><sub><em>k</em></sub>) + <em>F</em><sub><em>l</em></sub>(<em>x</em><sub><em>l</em></sub>).</span></p>
<p>The squared and scaled difference between the two sides of the equation leads to the statistic</p>
<p><span class="math display">$$
  H_{jkl}^2 = \frac{\frac{1}{n} \sum_{i = 1}^n \big[\hat F_{jkl}(x_{ij}, x_{ik}, x_{il}) - B^i_{jkl} + C^i_{jkl}\big]^2}{\frac{1}{n} \sum_{i = 1}^n \hat F_{jkl}(x_{ij}, x_{ik}, x_{il})^2},
$$</span></p>
<p>where</p>
<p><span class="math display"><em>B</em><sub><em>j</em><em>k</em><em>l</em></sub><sup><em>i</em></sup> = <em>F̂</em><sub><em>j</em><em>k</em></sub>(<em>x</em><sub><em>i</em><em>j</em></sub>,<em>x</em><sub><em>i</em><em>k</em></sub>) + <em>F̂</em><sub><em>j</em><em>l</em></sub>(<em>x</em><sub><em>i</em><em>j</em></sub>,<em>x</em><sub><em>i</em><em>l</em></sub>) + <em>F̂</em><sub><em>k</em><em>l</em></sub>(<em>x</em><sub><em>i</em><em>k</em></sub>,<em>x</em><sub><em>i</em><em>l</em></sub>)</span></p>
<p>and</p>
<p><span class="math display"><em>C</em><sub><em>j</em><em>k</em><em>l</em></sub><sup><em>i</em></sup> = <em>F̂</em><sub><em>j</em></sub>(<em>x</em><sub><em>i</em><em>j</em></sub>) + <em>F̂</em><sub><em>k</em></sub>(<em>x</em><sub><em>i</em><em>k</em></sub>) + <em>F̂</em><sub><em>l</em></sub>(<em>x</em><sub><em>i</em><em>l</em></sub>).</span></p>
<p>Similar remarks as for <span class="math inline"><em>H</em><sub><em>j</em><em>k</em></sub><sup>2</sup></span> apply.</p>
</div>
<div class="section level3">
<h3 id="total-interaction-strength-of-all-variables-together">Total interaction strength of all variables together<a class="anchor" aria-label="anchor" href="#total-interaction-strength-of-all-variables-together"></a>
</h3>
<p>If the model is additive in all features (no interactions), then</p>
<p><span class="math display">$$
    F(\boldsymbol x) = \sum_{j}^{p} F_j(x_j),
$$</span></p>
<p>i.e., the (centered) predictions can be written as the sum of the (centered) main effects.</p>
<p>To measure the relative amount of variability unexplained by all main effects, we can therefore study the test statistic of total interaction strength</p>
<p><span class="math display">$$
  H^2 = \frac{\frac{1}{n} \sum_{i = 1}^n \left[F(\boldsymbol x_i) - \sum_{j = 1}^p\hat F_j(x_{ij})\right]^2}{\frac{1}{n} \sum_{i = 1}^n\left[F(\boldsymbol x_i)\right]^2}.
$$</span></p>
<p>A value of 0 means there are no interaction effects at all. Due to (typically undesired) extrapolation effects of partial dependence functions, depending on the model, values above 1 may occur.</p>
<p>In [5], <span class="math inline">1 − <em>H</em><sup>2</sup></span> is called <em>additivity index</em>. A similar measure using accumulated local effects is discussed in [6].</p>
</div>
<div class="section level3">
<h3 id="workflow">Workflow<a class="anchor" aria-label="anchor" href="#workflow"></a>
</h3>
<p>Calculation of all <span class="math inline"><em>H</em><sub><em>j</em></sub><sup>2</sup></span> requires <span class="math inline"><em>O</em>(<em>n</em><sup>2</sup><em>p</em>)</span> predictions, while calculating of all pairwise <span class="math inline"><em>H</em><sub><em>j</em><em>k</em></sub></span> requires <span class="math inline"><em>O</em>(<em>n</em><sup>2</sup><em>p</em><sup>2</sup></span> predictions. Therefore, we suggest to reduce the workflow in two important ways:</p>
<ol style="list-style-type: decimal">
<li>Evaluate the statistics only on a subset of the data, e.g., on <span class="math inline"><em>n</em>′ = 500</span> observations.</li>
<li>Calculate <span class="math inline"><em>H</em><sub><em>j</em></sub><sup>2</sup></span> for all features. Then, select a small number <span class="math inline">$m = O(\sqrt{p})$</span> of features with highest <span class="math inline"><em>H</em><sub><em>j</em></sub><sup>2</sup></span> and do pairwise calculations only on this subset.</li>
</ol>
<p>This leads to a total number of <span class="math inline"><em>O</em>(<em>n</em>′<sup>2</sup><em>p</em>)</span> predictions. If also three-way interactions are to be studied, <span class="math inline"><em>m</em></span> should be of the order <span class="math inline"><em>p</em><sup>1/3</sup></span>.</p>
</div>
<div class="section level3">
<h3 id="variable-importance-experimental">Variable importance (experimental)<a class="anchor" aria-label="anchor" href="#variable-importance-experimental"></a>
</h3>
<p>[4] proposed the standard deviation of the partial dependence function as a measure of variable importance (for continuous predictors).</p>
<p>Since the partial dependence function suppresses interaction effects, we propose a different measure in the spirit of the interaction statistics above: If <span class="math inline"><em>x</em><sub><em>j</em></sub></span> has no effects, the (centered) prediction function <span class="math inline"><em>F</em></span> equals the (centered) partial dependence <span class="math inline"><em>F</em><sub>\<em>j</em></sub></span> on all other features <span class="math inline"><strong>x</strong><sub>\<em>j</em></sub></span>, i.e.,</p>
<p><span class="math display"><em>F</em>(<strong>x</strong>) = <em>F</em><sub>\<em>j</em></sub>(<strong>x</strong><sub>\<em>j</em></sub>).</span></p>
<p>Therefore, the following measure of variable importance follows:</p>
<p><span class="math display">$$
    PDI_{j} = \frac{\frac{1}{n} \sum_{i = 1}^n\big[F(\boldsymbol x_i) - \hat F_{\setminus j}(\boldsymbol x_{i\setminus j})\big]^2}{\frac{1}{n} \sum_{i = 1}^n\big[F(\boldsymbol x_i)\big]^2}.
$$</span></p>
<p>It differs from <span class="math inline"><em>H</em><sub><em>j</em></sub><sup>2</sup></span> only by not subtracting the main effect of the <span class="math inline"><em>j</em></span>-th feature in the numerator. It can be read as the proportion of prediction variability unexplained by all other features. As such, it measures variable importance of the <span class="math inline"><em>j</em></span>-th feature, including its interaction effects.</p>
</div>
</div>
<div class="section level2">
<h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<ol style="list-style-type: decimal">
<li>Friedman, Jerome H., and Bogdan E. Popescu. <em>Predictive Learning via Rule Ensembles.</em> The Annals of Applied Statistics 2, no. 3 (2008): 916-54.</li>
<li>Friedman, Jerome H. <em>Greedy Function Approximation: A Gradient Boosting Machine.</em> Annals of Statistics 29, no. 5 (2001): 1189-1232.</li>
<li>Mayer, Michael, Steven C. Bourassa, Martin Hoesli, and Donato Scognamiglio. <em>Machine Learning Applications to Land and Structure Valuation.”</em> Journal of Risk and Financial Management 15, no. 5 (2022): 193.</li>
<li>Greenwell, Brandon M., Bradley C. Boehmke, and Andrew J. McCarthy. <em>A Simple and Effective Model-Based Variable Importance Measure.</em> Arxiv (2018).</li>
<li>Żółkowski, Artur, Mateusz Krzyziński, and Paweł Fijałkowski. <em>Methods for extraction of interactions from predictive models.</em> Undergraduate thesis. Faculty of Mathematics and Information Science, Warsaw University of Technology (2023).</li>
<li>Molnar, Christoph, Giuseppe Casalicchio, and Bernd Bischl”. <em>Quantifying Model Complexity via Functional Decomposition for Better Post-hoc Interpretability</em>, in Machine Learning and Knowledge Discovery in Databases, Springer International Publishing (2020): 193-204.</li>
<li>Goldstein, Alex, Adam Kapelner, Justin Bleich, and Emil Pitkin. <em>Peeking inside the black box: Visualizing statistical learning with plots of individual conditional expectation.</em> Journal of Computational and Graphical Statistics, 24, no. 1 (2015): 44-65.</li>
<li>Apley, Daniel W., and Jingyu Zhu, <em>Visualizing the Effects of Predictor Variables in Black Box Supervised Learning Models</em>, Arxiv (2016).</li>
</ol>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <div class="links">
<h2 data-toc-skip>Links</h2>
<ul class="list-unstyled">
<li><a href="https://cloud.r-project.org/package=hstats" class="external-link">View on CRAN</a></li>
<li><a href="https://github.com/mayer79/hstats/" class="external-link">Browse source code</a></li>
<li><a href="https://github.com/mayer79/hstats/issues" class="external-link">Report a bug</a></li>
</ul>
</div>

<div class="license">
<h2 data-toc-skip>License</h2>
<ul class="list-unstyled">
<li><a href="LICENSE.html">Full license</a></li>
<li><small>GPL (&gt;= 2)</small></li>
</ul>
</div>


<div class="citation">
<h2 data-toc-skip>Citation</h2>
<ul class="list-unstyled">
<li><a href="authors.html#citation">Citing hstats</a></li>
</ul>
</div>

<div class="developers">
<h2 data-toc-skip>Developers</h2>
<ul class="list-unstyled">
<li>Michael Mayer <br><small class="roles"> Author, maintainer </small>  </li>
</ul>
</div>

<div class="dev-status">
<h2 data-toc-skip>Dev status</h2>
<ul class="list-unstyled">
<li><a href="https://cran.r-project.org/package=hstats" class="external-link"><img src="http://www.r-pkg.org/badges/version/hstats" alt="CRAN status"></a></li>
<li><a href="https://github.com/mayer79/hstats/actions" class="external-link"><img src="https://github.com/mayer79/hstats/actions/workflows/R-CMD-check.yaml/badge.svg" alt="R-CMD-check"></a></li>
<li><a href="https://app.codecov.io/gh/mayer79/hstats?branch=main" class="external-link"><img src="https://codecov.io/gh/mayer79/hstats/graph/badge.svg" alt="Codecov test coverage"></a></li>
<li><a href="https://cran.r-project.org/package=hstats" class="external-link"><img src="https://cranlogs.r-pkg.org/badges/hstats"></a></li>
<li><a href="https://cran.r-project.org/package=hstats" class="external-link"><img src="https://cranlogs.r-pkg.org/badges/grand-total/hstats?color=orange"></a></li>
</ul>
</div>

  </div>
</div>


      <footer><div class="copyright">
  <p></p>
<p>Developed by Michael Mayer.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.9.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
